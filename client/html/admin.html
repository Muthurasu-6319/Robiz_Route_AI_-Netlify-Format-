<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Career Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #E2E8F0; }
        .stat-card { background-color: #1E293B; border: 1px solid #334155; }
        .active-link { background-color: #1E3A8A; color: #fff; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        .modal-content { background-color: #1E293B; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); transition: opacity 0.3s, transform 0.3s; z-index: 100; }
    </style>
</head>
<body class="antialiased">
    <div class="flex h-screen bg-slate-900">
        <!-- Sidebar -->
        <div class="w-64 bg-slate-800 flex flex-col">
            <div class="flex items-center justify-center h-20 border-b border-slate-700">
                <a href="#" class="text-2xl font-bold flex items-center gap-2 text-white">
                    <i data-lucide="shield-check" class="text-blue-400"></i> Admin Panel
                </a>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" id="nav-dashboard" class="nav-link flex items-center gap-3 px-4 py-2 text-white active-link rounded-lg"><i data-lucide="layout-dashboard"></i> Dashboard</a>
                <a href="#" id="nav-users" class="nav-link flex items-center gap-3 px-4 py-2 text-slate-300 hover:bg-slate-700 rounded-lg"><i data-lucide="users"></i> Users</a>
                <a href="#" id="nav-courses" class="nav-link flex items-center gap-3 px-4 py-2 text-slate-300 hover:bg-slate-700 rounded-lg"><i data-lucide="book-copy"></i> Courses</a>
                <a href="#" id="nav-pricing" class="nav-link flex items-center gap-3 px-4 py-2 text-slate-300 hover:bg-slate-700 rounded-lg"><i data-lucide="dollar-sign"></i> Pricing</a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-6 border-b border-slate-800">
                <h1 id="page-title" class="text-2xl font-bold text-white">Dashboard</h1>
                <button id="logout-btn" class="flex items-center gap-2 bg-slate-700 hover:bg-red-500/80 text-white font-semibold px-4 py-2 rounded-lg transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i> Logout</button>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-900 p-8">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="content-view">
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="stat-card p-6 rounded-xl"><h3 class="text-sm font-medium text-slate-400">Total Users</h3><p id="total-users" class="text-3xl font-bold text-white mt-2">0</p></div>
                        <div class="stat-card p-6 rounded-xl"><h3 class="text-sm font-medium text-slate-400">Total Courses</h3><p id="total-stacks" class="text-3xl font-bold text-white mt-2">0</p></div>
                        <div class="stat-card p-6 rounded-xl"><h3 class="text-sm font-medium text-slate-400">Total Revenue</h3><p id="total-revenue" class="text-3xl font-bold text-white mt-2">â‚¹0</p></div>
                     </div>
                     <div class="stat-card p-6 rounded-xl"><h3 class="text-lg font-semibold mb-4">User Status Distribution</h3><canvas id="userStatusChart"></canvas></div>
                </div>

                <!-- Users View -->
                <div id="users-view" class="hidden content-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-white">User Management</h2>
                        <div class="relative">
                            <button id="user-actions-btn" class="bg-blue-600 px-4 py-2 rounded-lg flex items-center gap-2">Actions <i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                            <div id="user-actions-dropdown" class="absolute hidden mt-2 w-48 bg-slate-700 rounded-lg shadow-lg z-10 right-0">
                                <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-600" data-action="Active">Set Active</a>
                                <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-600" data-action="Inactive">Set Inactive</a>
                                <a href="#" class="block px-4 py-2 text-sm hover:bg-slate-600" data-action="Banned">Set Banned</a>
                                <div class="border-t border-slate-600 my-1"></div>
                                <a href="#" class="block px-4 py-2 text-sm text-red-400 hover:bg-slate-600" data-action="delete">Delete Selected</a>
                            </div>
                        </div>
                    </div>
                     <div class="bg-slate-800/50 rounded-lg border border-slate-700 overflow-x-auto">
                        <table class="w-full text-left table-auto">
                            <thead>
                                <tr class="bg-slate-700/50">
                                    <th class="p-4"><input type="checkbox" id="select-all-users"></th>
                                    <th class="p-4 text-sm font-semibold text-slate-400">User Info</th>
                                    <th class="p-4 text-sm font-semibold text-slate-400">Status</th>
                                    <th class="p-4 text-sm font-semibold text-slate-400">Last Login</th>
                                    <th class="p-4 text-sm font-semibold text-slate-400">Created At</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-slate-700"></tbody>
                        </table>
                     </div>
                </div>

                <!-- Courses View -->
                <div id="courses-view" class="hidden content-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-white">Course Management</h2>
                        <button id="add-stack-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Add New Course</button>
                    </div>
                    <div class="space-y-4" id="stacks-container"></div>
                </div>

                <!-- Pricing View -->
                <div id="pricing-view" class="hidden content-view">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-xl font-semibold text-white">Plan Management</h2>
                         <button id="add-plan-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Create New Plan</button>
                    </div>
                     <div class="bg-slate-800/50 rounded-lg border border-slate-700 overflow-x-auto">
                        <table class="w-full text-left table-auto">
                            <thead><tr class="bg-slate-700/50"><th class="p-4 text-sm font-semibold">Name</th><th class="p-4 text-sm font-semibold">Price</th><th class="p-4 text-sm font-semibold">Type</th><th class="p-4 text-sm font-semibold">Status</th><th class="p-4 text-sm font-semibold">Actions</th></tr></thead>
                            <tbody id="pricing-table-body" class="divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="stack-modal" class="fixed inset-0 modal-bg flex items-center justify-center hidden z-50">
        <div class="modal-content p-8 rounded-lg w-full max-w-3xl border border-slate-700 max-h-[90vh] flex flex-col">
            <h2 id="stack-modal-title" class="text-2xl font-bold mb-6">Add New Course</h2>
            <form id="stack-form" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <input type="hidden" id="stack-edit-id">
                <input type="text" id="stack-id" placeholder="Course ID (e.g., new-course)" class="w-full bg-slate-700 rounded p-2" required>
                <input type="text" id="stack-name" placeholder="Course Name" class="w-full bg-slate-700 rounded p-2" required>
                <textarea id="stack-description" placeholder="Description" class="w-full bg-slate-700 rounded p-2" required></textarea>
                <textarea id="stack-details" rows="15" placeholder="JSON Details for modules, curriculum, tasks..." class="w-full bg-slate-700 rounded p-2 font-mono text-xs" required></textarea>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="close-modal bg-slate-600 px-4 py-2 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-600 px-4 py-2 rounded">Save Course</button>
                </div>
            </form>
        </div>
    </div>

    <div id="plan-modal" class="fixed inset-0 modal-bg flex items-center justify-center hidden z-50">
         <div class="modal-content p-8 rounded-lg w-full max-w-lg border border-slate-700">
             <h2 id="plan-modal-title" class="text-2xl font-bold mb-6">Create New Plan</h2>
             <form id="plan-form" class="space-y-4">
                <input type="hidden" id="plan-edit-id">
                <input type="text" id="plan-name" placeholder="Plan Name" class="w-full bg-slate-700 rounded p-2" required>
                <input type="number" id="plan-price" placeholder="Price (e.g., 499)" class="w-full bg-slate-700 rounded p-2" required>
                <input type="text" id="plan-type" placeholder="Type (e.g., Monthly, Lifetime)" class="w-full bg-slate-700 rounded p-2" required>
                <textarea id="plan-features" placeholder="Features (one per line)" class="w-full bg-slate-700 rounded p-2" required></textarea>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="close-modal bg-slate-600 px-4 py-2 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-600 px-4 py-2 rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
        (function() {
            document.addEventListener('DOMContentLoaded', () => {
                const views = { dashboard: document.getElementById('dashboard-view'), users: document.getElementById('users-view'), courses: document.getElementById('courses-view'), pricing: document.getElementById('pricing-view'), };
                const navLinks = { dashboard: document.getElementById('nav-dashboard'), users: document.getElementById('nav-users'), courses: document.getElementById('nav-courses'), pricing: document.getElementById('nav-pricing'), };
                const pageTitle = document.getElementById('page-title');
                let userStatusChart;

                const API_BASE = '/api'; 

                const showToast = (message, isSuccess = true) => {
                    const toastContainer = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `toast p-4 rounded-lg shadow-lg text-white ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
                    toast.textContent = message;
                    toastContainer.appendChild(toast);
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateY(20px)';
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                };

                const switchView = (viewName) => {
                    Object.values(views).forEach(v => v.classList.add('hidden'));
                    Object.values(navLinks).forEach(l => l.classList.remove('active-link', 'text-white'));
                    views[viewName].classList.remove('hidden');
                    navLinks[viewName].classList.add('active-link', 'text-white');
                    pageTitle.textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);
                    
                    if (viewName === 'dashboard') fetchDashboardStats();
                    if (viewName === 'users') fetchUsers();
                    if (viewName === 'courses') fetchStacks();
                    if (viewName === 'pricing') fetchPricing();
                };

                Object.keys(navLinks).forEach(key => navLinks[key].addEventListener('click', (e) => { e.preventDefault(); switchView(key); }));

                const fetchAPI = async (url, options = {}) => {
                    try {
                        const response = await fetch(`${API_BASE}${url}`, options);
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.message || 'API request failed');
                        }
                        if (response.status === 204) return null;
                        return response.json();
                    } catch (error) {
                        showToast(error.message, false);
                        console.error('API Error:', error);
                        return null;
                    }
                };

                const fetchDashboardStats = async () => {
                    const data = await fetchAPI('/admin/dashboard');
                    if (!data) return;
                    document.getElementById('total-users').textContent = data.totalUsers;
                    document.getElementById('total-stacks').textContent = data.totalStacks;
                    document.getElementById('total-revenue').textContent = `â‚¹${data.totalRevenue}`;
                    
                    const ctx = document.getElementById('userStatusChart').getContext('2d');
                    if(userStatusChart) userStatusChart.destroy();
                    const chartData = { labels: [], datasets: [{ data: [], backgroundColor: [] }] };
                    const colorMap = { 'Active': '#22c55e', 'Inactive': '#facc15', 'Banned': '#ef4444' };
                    if(data.userStats && data.userStats.length > 0) {
                        data.userStats.forEach(s => {
                            chartData.labels.push(s.status);
                            chartData.datasets[0].data.push(s.count);
                            chartData.datasets[0].backgroundColor.push(colorMap[s.status] || '#64748b');
                        });
                    } else {
                         chartData.labels.push('No Users');
                         chartData.datasets[0].data.push(1);
                         chartData.datasets[0].backgroundColor.push('#64748b');
                    }

                    userStatusChart = new Chart(ctx, {
                        type: 'doughnut', data: chartData,
                        options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#e2e8f0' } } } }
                    });
                };

                const fetchUsers = async () => {
                    const users = await fetchAPI('/admin/users');
                    const tableBody = document.getElementById('users-table-body');
                    if(!tableBody) return;
                    tableBody.innerHTML = '';
                    if (!users || users.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-slate-400">No users found.</td></tr>';
                        return;
                    };
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        const statusColor = user.status === 'Active' ? 'bg-green-500/20 text-green-300' : (user.status === 'Banned' ? 'bg-red-500/20 text-red-300' : 'bg-yellow-500/20 text-yellow-300');
                        row.innerHTML = `
                            <td class="p-4"><input type="checkbox" class="user-checkbox bg-slate-700" data-id="${user.id}"></td>
                            <td class="p-4">${user.name}<br><small class="text-slate-400">${user.email}</small></td>
                            <td class="p-4"><span class="px-2 py-1 text-xs rounded-full ${statusColor}">${user.status}</span></td>
                            <td class="p-4 text-slate-400">${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                            <td class="p-4 text-slate-400">${new Date(user.created_at).toLocaleDateString()}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                };
                
                const fetchStacks = async () => {
                    const stacks = await fetchAPI('/admin/stacks');
                    const container = document.getElementById('stacks-container');
                    if(!container) return;
                    container.innerHTML = '';
                     if (!stacks || stacks.length === 0) {
                        container.innerHTML = '<p class="text-center p-8 text-slate-400">No courses found. Add one to get started!</p>';
                        return;
                    };
                    stacks.forEach(stack => {
                        const div = document.createElement('div');
                        div.className = 'bg-slate-700/50 p-4 rounded-lg flex items-center justify-between';
                        div.innerHTML = `
                            <div>
                                <h3 class="text-lg font-semibold text-white">${stack.name}</h3>
                                <p class="text-sm text-slate-400">${stack.id}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="edit-stack-btn p-2 hover:bg-slate-600 rounded" data-id="${stack.id}"><i class="w-4 h-4" data-lucide="edit"></i></button>
                                <button class="duplicate-stack-btn p-2 hover:bg-slate-600 rounded" data-id="${stack.id}"><i class="w-4 h-4" data-lucide="copy"></i></button>
                                <button class="delete-stack-btn p-2 hover:bg-red-500/80 rounded" data-id="${stack.id}"><i class="w-4 h-4" data-lucide="trash"></i></button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                    lucide.createIcons();
                };

                const fetchPricing = async () => {
                    const plans = await fetchAPI('/admin/pricing');
                    const tableBody = document.getElementById('pricing-table-body');
                    if(!tableBody) return;
                    tableBody.innerHTML = '';
                    if (!plans || plans.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-slate-400">No pricing plans found.</td></tr>';
                        return;
                    };
                    plans.forEach(plan => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="p-4 font-semibold">${plan.name}</td>
                            <td class="p-4 text-slate-300">â‚¹${plan.price}</td>
                            <td class="p-4 text-slate-400">${plan.type}</td>
                            <td class="p-4"><span class="px-2 py-1 text-xs rounded-full ${plan.status === 'enabled' ? 'bg-green-500/20 text-green-300' : 'bg-slate-500/20 text-slate-300'}">${plan.status}</span></td>
                            <td class="p-4 flex gap-2">
                               <button class="toggle-plan-status p-2 hover:bg-slate-600 rounded" data-id="${plan.id}" data-status="${plan.status}">${plan.status === 'enabled' ? '<i data-lucide="eye-off" class="w-4 h-4"></i>' : '<i data-lucide="eye" class="w-4 h-4"></i>'}</button>
                               <button class="delete-plan-btn p-2 hover:bg-red-500/80 rounded" data-id="${plan.id}"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    lucide.createIcons();
                };

                document.getElementById('user-actions-btn')?.addEventListener('click', () => document.getElementById('user-actions-dropdown').classList.toggle('hidden'));
                document.getElementById('user-actions-dropdown')?.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const action = e.target.dataset.action;
                    if (!action) return;
                    const selectedIds = [...document.querySelectorAll('.user-checkbox:checked')].map(cb => cb.dataset.id);
                    if (selectedIds.length === 0) return showToast('No users selected.', false);
                    
                    const endpoint = action === 'delete' ? '/admin/users/delete' : '/admin/users/update-status';
                    const body = action === 'delete' ? { userIds: selectedIds } : { userIds: selectedIds, status: action };
                    
                    const result = await fetchAPI(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (result) { showToast(result.message); fetchUsers(); }
                    document.getElementById('user-actions-dropdown').classList.add('hidden');
                });
                document.getElementById('select-all-users')?.addEventListener('change', (e) => {
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
                });

                const stackModal = document.getElementById('stack-modal');
                document.getElementById('add-stack-btn')?.addEventListener('click', () => {
                    document.getElementById('stack-form').reset();
                    document.getElementById('stack-edit-id').value = '';
                    document.getElementById('stack-id').disabled = false;
                    document.getElementById('stack-modal-title').textContent = 'Add New Course';
                    stackModal.classList.remove('hidden');
                });
                document.getElementById('stacks-container')?.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-stack-btn');
                    const deleteBtn = e.target.closest('.delete-stack-btn');
                    const duplicateBtn = e.target.closest('.duplicate-stack-btn');
                    if (editBtn) {
                        const stacks = await fetchAPI('/admin/stacks');
                        if (!stacks) return;
                        const stack = stacks.find(s => s.id === editBtn.dataset.id);
                        if (stack) {
                            document.getElementById('stack-edit-id').value = stack.id;
                            document.getElementById('stack-id').value = stack.id;
                            document.getElementById('stack-id').disabled = true;
                            document.getElementById('stack-name').value = stack.name;
                            document.getElementById('stack-description').value = stack.description;
                            document.getElementById('stack-details').value = JSON.stringify(stack.details, null, 2);
                            document.getElementById('stack-modal-title').textContent = 'Edit Course';
                            stackModal.classList.remove('hidden');
                        }
                    }
                    if (deleteBtn) {
                        if (confirm('Are you sure you want to delete this course?')) {
                            const result = await fetchAPI(`/admin/stacks/${deleteBtn.dataset.id}`, { method: 'DELETE' });
                            if (result) { showToast(result.message); fetchStacks(); }
                        }
                    }
                     if (duplicateBtn) {
                        if (confirm('Are you sure you want to duplicate this course?')) {
                            const result = await fetchAPI(`/admin/stacks/duplicate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({id: duplicateBtn.dataset.id}) });
                            if (result) { showToast(result.message); fetchStacks(); }
                        }
                    }
                });
                 document.getElementById('stack-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const editId = document.getElementById('stack-edit-id').value;
                    let details;
                    try {
                        details = {
                            id: document.getElementById('stack-id').value,
                            name: document.getElementById('stack-name').value,
                            description: document.getElementById('stack-description').value,
                            details: JSON.parse(document.getElementById('stack-details').value)
                        };
                    } catch(err) { return showToast('Invalid JSON in details field.', false); }
                    const url = editId ? `/admin/stacks/${editId}` : '/admin/stacks';
                    const method = editId ? 'PUT' : 'POST';
                    const result = await fetchAPI(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(details) });
                    if (result) { showToast(result.message); fetchStacks(); stackModal.classList.add('hidden'); }
                });


                const planModal = document.getElementById('plan-modal');
                document.getElementById('add-plan-btn')?.addEventListener('click', () => {
                    document.getElementById('plan-form').reset();
                    planModal.classList.remove('hidden');
                });
                document.getElementById('pricing-table-body')?.addEventListener('click', async (e) => {
                     const toggleBtn = e.target.closest('.toggle-plan-status');
                     const deleteBtn = e.target.closest('.delete-plan-btn');
                     if(toggleBtn){
                        const newStatus = toggleBtn.dataset.status === 'enabled' ? 'disabled' : 'enabled';
                        const result = await fetchAPI(`/admin/pricing/${toggleBtn.dataset.id}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                        if(result) { showToast(result.message); fetchPricing(); }
                     }
                     if(deleteBtn){
                        if(confirm('Are you sure you want to delete this plan?')){
                            const result = await fetchAPI(`/admin/pricing/${deleteBtn.dataset.id}`, { method: 'DELETE' });
                            if(result) { showToast(result.message); fetchPricing(); }
                        }
                     }
                });
                 document.getElementById('plan-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const plan = {
                        name: document.getElementById('plan-name').value,
                        price: document.getElementById('plan-price').value,
                        type: document.getElementById('plan-type').value,
                        features: document.getElementById('plan-features').value.split('\n').filter(f => f.trim())
                    };
                    const result = await fetchAPI('/admin/pricing', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(plan) });
                    if (result) { showToast(result.message); fetchPricing(); planModal.classList.add('hidden'); }
                });
                
                document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => {
                    stackModal.classList.add('hidden');
                    planModal.classList.add('hidden');
                }));
                document.getElementById('logout-btn').addEventListener('click', () => { sessionStorage.clear(); window.location.href = '/login.html'; });
                
                lucide.createIcons();
                switchView('dashboard');
            });
        })();
    </script>
</body>
</html>
